<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Schema</title>
  <link rel="stylesheet" href="override.css">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1976d2">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Schema">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon-180.png">
  <link rel="icon" href="icons/icon-192.png" sizes="192x192">

  <style>
    :root{
      --blue:#1976d2; --bg:#f2f4f7; --card:#fff; --text:#0b1220;
      --muted:#6b7280; --green:#2e7d32; --red:#d32f2f;
      --orange:#f59e0b;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    .app{max-width:420px;margin:0 auto;min-height:100vh;background:var(--bg);padding-bottom:calc(78px + env(safe-area-inset-bottom))}

    .topbar{
      background:var(--blue);color:#fff;padding:14px 16px 12px;
      border-bottom-left-radius:22px;border-bottom-right-radius:22px;
    }
    .toprow{display:flex;align-items:center;justify-content:space-between}
    .title{font-weight:900;font-size:20px}
    .navarrows{display:flex;gap:10px;align-items:center}
    .arrow{font-weight:900;opacity:.95;cursor:pointer;user-select:none;padding:6px 10px;border-radius:10px;background:rgba(255,255,255,.14)}

    .pillrow{display:flex;gap:14px;margin-top:10px}
    .pill{flex:1;background:rgba(255,255,255,.16);border-radius:14px;padding:10px 12px}
    .pill .label{font-size:12px;opacity:.95;font-weight:800}
    .pill .value{font-size:22px;font-weight:950;margin-top:2px}
    .pill .sub{font-size:12px;opacity:.95;margin-top:4px}

    .pill .sub .meta{opacity:.92}

    .dow{font-size:12px;color:rgba(255,255,255,.92);display:grid;grid-template-columns:repeat(7,1fr);gap:10px;margin-top:12px}
    .dow div{text-align:center;font-weight:800;opacity:.95}

    .card{background:var(--card);border-radius:var(--radius);box-shadow:0 6px 20px rgba(10,20,30,.06)}
    .content{padding:14px 14px 0}

    /* ‚úÖ proffsig kalender-grid */
    .grid{
      display:grid;
      grid-template-columns:repeat(7, 1fr);
      gap:10px;
    }
    .day{
      background:#fff;
      border-radius:14px;
      padding:10px 10px 8px;
      cursor:pointer;
      /*
        Om bordern √§r transparent och bakgrunden √§r vit (samma som kortet)
        ser det ut som att dagar "f√∂rsvinner". En svag border g√∂r rutorna tydliga.
      */
      border:1px solid #e5e7eb;

      aspect-ratio: 1 / 1;
      min-height: 54px;

      display:flex;
      flex-direction:column;
      justify-content:flex-start;
    }
    .day.muted{
      opacity:1;
      cursor:default;
      background:#f6f7fb;
      border-color:#eef1f5;
    }
    .day .d{
      font-size:12px;
      color:#334155;
      font-weight:950;
      line-height:1;
    }
    .chip{
      margin-top:8px;
      font-size:10px;
      line-height:1.1;
      padding:6px 7px;
      border-radius:999px;
      background:#e9f2ff;
      color:#0b3b7a;
      font-weight:950;
      display:block;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .day.done{ border-color:#8fd2a0; }
    .day.done .chip{ background:#e7f6ea; color:#1b5e20; }
    .day.sick{ border-color:#f1a3a3; }
    .day.sick .chip{ background:#fde8e8; color:#7f1d1d; }
    .day.vab{ border-color:#f7c37a; }
    .day.vab .chip{ background:#fff3d6; color:#7a4a00; }
    .day.today{ box-shadow:0 0 0 3px rgba(25,118,210,.18); }

    .hint{font-size:12px;color:var(--muted);margin-top:10px}

    .sheet{
      position:fixed;left:0;right:0;bottom:-120%;transition:.25s;
      max-width:420px;margin:0 auto;background:#fff;border-top-left-radius:22px;border-top-right-radius:22px;
      box-shadow:0 -20px 60px rgba(0,0,0,.18);padding:10px 14px 16px;
    }
    .sheet.open{bottom:calc(70px + env(safe-area-inset-bottom, 0px))}
    .sheethead{display:flex;align-items:center;justify-content:space-between;padding:8px 0 10px}
    .back{font-weight:950;color:var(--blue);cursor:pointer}
    .sheettitle{font-weight:950;text-align:center;flex:1}
    .row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid #eef1f5}
    .row .l{color:var(--muted);font-weight:900}
    .row .r{font-weight:950;color:var(--blue)}
    .input{
      width:120px;padding:10px 10px;border-radius:12px;border:1px solid #e5e7eb;
      font-weight:950;color:#0b3b7a;background:#f9fafb;
    }
    .btn{width:100%;border:0;border-radius:14px;padding:14px 14px;margin-top:10px;font-size:16px;font-weight:950;cursor:pointer}
    .btn.green{background:var(--green);color:#fff}
    .btn.red{background:var(--red);color:#fff}
    .btn.blue{background:var(--blue);color:#fff}
    .btn.gray{background:#eef1f5;color:#223}

    .btnrow{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px}
    .btn.small{padding:12px 12px;font-size:15px;margin-top:0}
    .btn.outline{background:#fff;border:2px solid #e5e7eb;color:#223}
    .btn.outline.active{border-color:var(--blue);box-shadow:0 0 0 3px rgba(25,118,210,.12)}

    .tabs{display:flex;gap:10px;background:#eef3fb;border-radius:999px;padding:6px}
    .tab{flex:1;text-align:center;padding:8px 10px;border-radius:999px;font-weight:950;color:#335;cursor:pointer}
    .tab.active{background:var(--blue);color:#fff}
    .sumcard{margin-top:14px;padding:14px}
    .sumtitle{font-weight:950;font-size:18px}
    .badge{display:flex;align-items:center;justify-content:space-between;margin-top:10px;padding:10px;border-radius:14px;background:#f6f8fb}
    .badge.green{background:#e7f6ea}
    .badge.red{background:#fde8e8}
    .badge.blue{background:#e9f2ff}

    .nav{
      position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid #e9edf2;
      max-width:420px;margin:0 auto;display:flex;gap:8px;justify-content:space-around;
      padding:10px 10px calc(14px + env(safe-area-inset-bottom, 0px));
    }
    .nav button{border:0;background:transparent;font-weight:950;color:#64748b;cursor:pointer}
    .nav button.active{color:var(--blue)}
  </style>
</head>

<body>
<div class="app">
  <div class="topbar">
    <div class="toprow">
      <div class="title" id="monthTitle">Februari 2026</div>
      <div class="navarrows">
        <div class="arrow" onclick="goToday()">Idag</div>
        <div class="arrow" onclick="prevMonth()">‚Äπ</div>
        <div class="arrow" onclick="nextMonth()">‚Ä∫</div>
      </div>
    </div>

    <div class="pillrow">
      <div class="pill">
        <div class="label">Denna vecka</div>
        <div class="value" id="weekWorked">0 h</div>
        <div class="sub"><span class="meta" id="weekMeta">v. ‚Äì</span> ¬∑ Planerat: <strong id="weekPlanned">0 h</strong></div>
      </div>
      <div class="pill">
        <div class="label">Denna m√•nad</div>
        <div class="value" id="monthWorked">0 h</div>
        <div class="sub">Planerat: <strong id="monthPlanned">0 h</strong></div>
      </div>
    </div>

    <div class="dow">
      <div>M√•n</div><div>Tis</div><div>Ons</div><div>Tor</div><div>Fre</div><div>L√∂r</div><div>S√∂n</div>
    </div>
  </div>

  <div class="content">
    <div id="viewCalendar">
      <div class="card" style="padding:12px">
        <div class="grid" id="calGrid"></div>
      </div>
      <div class="hint">Tips: Klicka p√• en dag f√∂r att l√§gga till/√§ndra pass och markera Klar/Sjuk.</div>
    </div>

    <div id="viewSummary" style="display:none">
      <div class="card sumcard">
        <div class="tabs">
          <div class="tab active" id="tabWeek" onclick="setSumTab('week')">Vecka</div>
          <div class="tab" id="tabMonth" onclick="setSumTab('month')">M√•nad</div>
          <div class="tab" id="tabYear" onclick="setSumTab('year')">√Ör</div>
        </div>

        <div style="margin-top:12px">
          <div class="sumtitle">Totalt jobbade timmar</div>
          <div style="font-size:28px;font-weight:950;margin-top:6px" id="sumWorked">0 h</div>

          <div class="badge blue">
            <div style="font-weight:950">üìå Planerat</div>
            <div style="font-weight:950" id="sumPlanned">0 h</div>
          </div>

          <div class="badge green">
            <div style="font-weight:950">‚úÖ Klar/Gjord</div>
            <div style="font-weight:950" id="sumDone">0 h</div>
          </div>

          <div class="badge red">
            <div style="font-weight:950">üü• Sjuk/VAB</div>
            <div style="font-weight:950" id="sumSick">0 dagar</div>
          </div>
        </div>
      </div>
    </div>

    <div id="viewSettings" style="display:none">
      <div class="card sumcard">
        <div class="sumtitle">Inst√§llningar</div>
        <div class="badge blue" style="margin-top:12px">
          <div style="font-weight:950">‚è±Ô∏è Standardrast</div>
          <div>
            <input class="input" style="width:90px" id="sDefaultBreak" type="number" min="0" step="5" value="30" />
          </div>
        </div>

        <div class="hint" style="margin-top:10px">
          Standardrasten anv√§nds n√§r du √∂ppnar en ny dag som inte redan har ett pass.
        </div>

        <div style="margin-top:14px">
          <button class="btn gray" onclick="exportData()">üì§ Exportera data (JSON)</button>
          <label class="btn gray" style="display:block;text-align:center">
            üì• Importera data (JSON)
            <input id="importFile" type="file" accept="application/json" style="display:none" onchange="importData(event)" />
          </label>
          <button class="btn red" onclick="resetAll()">üß® Nollst√§ll allt</button>
        </div>

        <div class="hint" style="margin-top:10px">
          Tips: exportera ibland f√∂r backup.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Day sheet -->
<div class="sheet" id="sheet">
  <div class="sheethead">
    <div class="back" onclick="closeSheet()">‚Äπ Tillbaka</div>
    <div class="sheettitle" id="sheetTitle">Tisdag, 3 februari</div>
    <div style="width:60px"></div>
  </div>

  <div class="card" style="padding:12px">
    <div class="row">
      <div class="l">Start</div>
      <input class="input" id="iStart" type="time" />
    </div>
    <div class="row">
      <div class="l">Slut</div>
      <input class="input" id="iEnd" type="time" />
    </div>
    <div class="row">
      <div class="l">Rast (min)</div>
      <input class="input" id="iBreak" type="number" min="0" step="5" value="30" />
    </div>
    <div class="row" style="border-bottom:0">
      <div class="l">Betalda timmar</div>
      <div class="r" id="paidOut">0 h</div>
    </div>
  </div>

  <button class="btn gray" onclick="savePass()">üíæ Spara pass</button>

  <div class="btnrow">
    <button class="btn small outline" id="btnPlanned" onclick="mark('planned')">üìå Planerad</button>
    <button class="btn small outline" id="btnDone" onclick="mark('done')">‚úÖ Klar/Gjord</button>
    <button class="btn small outline" id="btnSick" onclick="mark('sick')">üü• Sjuk</button>
    <button class="btn small outline" id="btnVab" onclick="mark('vab')">üüß VAB</button>
  </div>

  <button class="btn blue" onclick="clearDay()">üóëÔ∏è Ta bort dag (pass + status)</button>
</div>

<!-- Bottom nav -->
<div class="nav">
  <button id="navCal" class="active" onclick="showView('calendar')">Kalender</button>
  <button id="navSum" onclick="showView('summary')">Summering</button>
  <button id="navSet" onclick="showView('settings')">Inst√§llningar</button>
</div>

<script>
  const monthNames = ["Januari","Februari","Mars","April","Maj","Juni","Juli","Augusti","September","Oktober","November","December"];
  const dayNames = ["S√∂ndag","M√•ndag","Tisdag","Onsdag","Torsdag","Fredag","L√∂rdag"];
  function pad(n){ return String(n).padStart(2,"0"); }
  function ymd(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }

  function loadPassMap(){ return JSON.parse(localStorage.getItem("passMap") || "{}"); }
  function savePassMap(m){ localStorage.setItem("passMap", JSON.stringify(m)); }
  function loadStatus(){ return JSON.parse(localStorage.getItem("statusMap") || "{}"); }
  function saveStatus(m){ localStorage.setItem("statusMap", JSON.stringify(m)); }
  function loadSettings(){ return JSON.parse(localStorage.getItem("settings") || '{"defaultBreak":30}'); }
  function saveSettings(s){ localStorage.setItem("settings", JSON.stringify(s)); }

  function minutesBetween(start, end){
    const [sh,sm] = start.split(":").map(Number);
    const [eh,em] = end.split(":").map(Number);
    let s = sh*60+sm;
    let e = eh*60+em;
    if (e < s) e += 24*60;
    return e - s;
  }
  function paidHours(start,end,breakMin){
    if(!start || !end) return 0;
    const mins = minutesBetween(start,end) - (breakMin||0);
    return Math.max(0, mins/60);
  }
  function fmtH(h){ return (h % 1 === 0 ? h.toFixed(0) : h.toFixed(1)) + " h"; }

  const _now = new Date();
  let currentYear = _now.getFullYear();
  let currentMonth = _now.getMonth();
  let selectedDate = null;
  let sumTab = "week";

  // Demo-data (l√§gg till ?demo=1 i URL om du vill fylla p√• exempelpass)
  (function seedDemo(){
    if(!location.search.includes("demo=1")) return;
    const example = {
      [ymd(new Date(currentYear,currentMonth,2))]: {start:"16:00", end:"21:00", breakMin:0},
      [ymd(new Date(currentYear,currentMonth,3))]: {start:"14:00", end:"20:00", breakMin:30},
      [ymd(new Date(currentYear,currentMonth,4))]: {start:"07:00", end:"14:00", breakMin:30}
    };
    const m = loadPassMap();
    let changed = false;
    for(const k in example){
      if(!m[k]) { m[k] = example[k]; changed = true; }
    }
    if(changed) savePassMap(m);
  })();

  function isoWeekNumber(d){
    const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    const dayNum = date.getUTCDay() || 7;
    date.setUTCDate(date.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
    return Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
  }

  function weekRangeFor(dateObj){
    const d = new Date(dateObj);
    const dow = (d.getDay()+6)%7; // monday=0
    d.setDate(d.getDate()-dow);
    const start = new Date(d);
    const end = new Date(d); end.setDate(end.getDate()+6);
    return [start,end];
  }

  function render(){
    document.getElementById("monthTitle").textContent = `${monthNames[currentMonth]} ${currentYear}`;
    renderCalendar();
    updateTopTotals();
    updateSummary();
  }

function renderCalendar(){
  const grid = document.getElementById("calGrid");
  grid.innerHTML = "";

  const first = new Date(currentYear, currentMonth, 1);
  const firstDow = (first.getDay() + 6) % 7; // m√•n=0
  const daysInMonth = new Date(currentYear, currentMonth+1, 0).getDate();

  const passMap = loadPassMap();
  const statusMap = loadStatus();
  const totalCells = 42;

  for(let idx=0; idx<totalCells; idx++){
    const cell = document.createElement("div");
    cell.className = "day";

    const dayNum = idx - firstDow + 1;

    // ‚úÖ tomma rutor (f√∂re/efter m√•naden) ska √§nd√• synas som rutor
    if(dayNum < 1 || dayNum > daysInMonth){
      cell.classList.add("muted");
      cell.innerHTML = `<div class="d"></div><div></div>`;
      grid.appendChild(cell);
      continue;
    }

    const d = new Date(currentYear, currentMonth, dayNum);
    const key = ymd(d);

    const st = statusMap[key] || "planned";
    if(st==="done") cell.classList.add("done");
    if(st==="sick") cell.classList.add("sick");
    if(st==="vab") cell.classList.add("vab");

    // (valfritt) markera idag
    const today = new Date();
    if(today.getFullYear()===currentYear && today.getMonth()===currentMonth && today.getDate()===dayNum){
      cell.classList.add("today");
    }

    const p = passMap[key];
    const passText = p ? `${p.start}‚Äì${p.end}` : "";
    const label = (st==="sick") ? "Sjuk" : (st==="vab") ? "VAB" : (p ? passText : "");

    cell.innerHTML = `
      <div class="d">${dayNum}</div>
      ${label ? `<div class="chip">${label}</div>` : `<div></div>`}
    `;

    cell.onclick = () => openSheet(key);
    grid.appendChild(cell);
  }
}


  function openSheet(key){
    selectedDate = key;
    const d = new Date(key+"T00:00:00");
    document.getElementById("sheetTitle").textContent =
      `${dayNames[d.getDay()]}, ${d.getDate()} ${monthNames[d.getMonth()].toLowerCase()}`;

    const passMap = loadPassMap();
    const settings = loadSettings();
    const p = passMap[key] || {start:"", end:"", breakMin:settings.defaultBreak ?? 30};

    document.getElementById("iStart").value = p.start || "";
    document.getElementById("iEnd").value = p.end || "";
    document.getElementById("iBreak").value = (p.breakMin ?? 30);

    recalcPaid();
    syncStatusButtons();
    document.getElementById("sheet").classList.add("open");
  }
  function closeSheet(){ document.getElementById("sheet").classList.remove("open"); }

  function recalcPaid(){
    const s = document.getElementById("iStart").value;
    const e = document.getElementById("iEnd").value;
    const b = Number(document.getElementById("iBreak").value || 0);
    document.getElementById("paidOut").textContent = fmtH(paidHours(s,e,b));
  }
  document.getElementById("iStart").addEventListener("input", recalcPaid);
  document.getElementById("iEnd").addEventListener("input", recalcPaid);
  document.getElementById("iBreak").addEventListener("input", recalcPaid);

  function savePass(){
    if(!selectedDate) return;
    const s = document.getElementById("iStart").value;
    const e = document.getElementById("iEnd").value;
    const b = Number(document.getElementById("iBreak").value || 0);

    const passMap = loadPassMap();
    if(!s || !e) delete passMap[selectedDate];
    else passMap[selectedDate] = {start:s, end:e, breakMin:b};
    savePassMap(passMap);

    // Om man sparar ett pass p√• en tom dag: se till att status √§r minst "planned"
    const statusMap = loadStatus();
    if(!statusMap[selectedDate]){
      statusMap[selectedDate] = "planned";
      saveStatus(statusMap);
    }

    render();
  }

  function mark(status){
    if(!selectedDate) return;
    const statusMap = loadStatus();
    statusMap[selectedDate] = status;
    saveStatus(statusMap);
    render();
    syncStatusButtons();
    closeSheet();
  }

  function syncStatusButtons(){
    if(!selectedDate) return;
    const st = (loadStatus()[selectedDate] || "planned");
    const map = {
      planned: "btnPlanned",
      done: "btnDone",
      sick: "btnSick",
      vab: "btnVab",
    };
    for(const k of Object.values(map)){
      const el = document.getElementById(k);
      if(el) el.classList.remove("active");
    }
    const id = map[st] || "btnPlanned";
    const active = document.getElementById(id);
    if(active) active.classList.add("active");
  }

  function clearDay(){
    if(!selectedDate) return;
    if(!confirm("Ta bort pass och status f√∂r den h√§r dagen?") ) return;
    const passMap = loadPassMap();
    const statusMap = loadStatus();
    delete passMap[selectedDate];
    delete statusMap[selectedDate];
    savePassMap(passMap);
    saveStatus(statusMap);
    render();
    closeSheet();
  }

  // ‚úÖ Top: Jobbat + Planerat (vecka/m√•nad)
  function updateTopTotals(){
    const statusMap = loadStatus();
    const passMap = loadPassMap();

    let monthWorked = 0, monthPlanned = 0;
    let weekWorked = 0, weekPlanned = 0;

    const today = new Date();
    const base = (today.getFullYear()===currentYear && today.getMonth()===currentMonth)
      ? today : new Date(currentYear,currentMonth,1);
    const [ws,we] = weekRangeFor(base);
    const weekNo = isoWeekNumber(base);
    document.getElementById("weekMeta").textContent = `v. ${weekNo}`;

    const daysInMonth = new Date(currentYear, currentMonth+1, 0).getDate();
    for(let day=1; day<=daysInMonth; day++){
      const d = new Date(currentYear,currentMonth,day);
      const key = ymd(d);
      const p = passMap[key];
      if(!p) continue;

      const h = paidHours(p.start,p.end,p.breakMin);
      monthPlanned += h;
      if(d>=ws && d<=we) weekPlanned += h;

      const st = statusMap[key] || "planned";
      if(st==="done"){
        monthWorked += h;
        if(d>=ws && d<=we) weekWorked += h;
      }
    }

    document.getElementById("weekWorked").textContent = fmtH(weekWorked);
    document.getElementById("weekPlanned").textContent = fmtH(weekPlanned);
    document.getElementById("monthWorked").textContent = fmtH(monthWorked);
    document.getElementById("monthPlanned").textContent = fmtH(monthPlanned);
  }

  function showView(v){
    document.getElementById("viewCalendar").style.display = (v==="calendar") ? "" : "none";
    document.getElementById("viewSummary").style.display  = (v==="summary") ? "" : "none";
    document.getElementById("viewSettings").style.display = (v==="settings") ? "" : "none";
    document.getElementById("navCal").classList.toggle("active", v==="calendar");
    document.getElementById("navSum").classList.toggle("active", v==="summary");
    document.getElementById("navSet").classList.toggle("active", v==="settings");
  }

  function setSumTab(t){
    sumTab = t;
    document.getElementById("tabWeek").classList.toggle("active", t==="week");
    document.getElementById("tabMonth").classList.toggle("active", t==="month");
    document.getElementById("tabYear").classList.toggle("active", t==="year");
    updateSummary();
  }

  // ‚úÖ Summary: Planerat + Jobbat + Sjuk/VAB
  function updateSummary(){
    const statusMap = loadStatus();
    const passMap = loadPassMap();

    let keys = Object.keys(passMap);
    if(sumTab==="month"){
      keys = keys.filter(k => k.startsWith(`${currentYear}-${pad(currentMonth+1)}-`));
    } else if(sumTab==="year"){
      keys = keys.filter(k => k.startsWith(`${currentYear}-`));
    } else {
      const today = new Date();
      const base = (today.getFullYear()===currentYear && today.getMonth()===currentMonth)
        ? today : new Date(currentYear,currentMonth,1);
      const [ws,we] = weekRangeFor(base);
      keys = keys.filter(k=>{
        const d = new Date(k+"T00:00:00");
        return d>=ws && d<=we;
      });
    }

    let planned = 0, worked = 0, sickDays = 0;
    for(const k of keys){
      const p = passMap[k];
      const h = paidHours(p.start,p.end,p.breakMin);
      planned += h;

      const st = statusMap[k] || "planned";
      if(st==="done") worked += h;
      if(st==="sick" || st==="vab") sickDays += 1;
    }

    document.getElementById("sumWorked").textContent = fmtH(worked);
    document.getElementById("sumPlanned").textContent = fmtH(planned);
    document.getElementById("sumDone").textContent = fmtH(worked);
    document.getElementById("sumSick").textContent = `${sickDays} dagar`;
  }

  function nextMonth(){
    currentMonth += 1;
    if(currentMonth>11){ currentMonth=0; currentYear+=1; }
    render();
  }
  function prevMonth(){
    currentMonth -= 1;
    if(currentMonth<0){ currentMonth=11; currentYear-=1; }
    render();
  }

  // Offline
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
  }

  // Settings UI
  (function initSettings(){
    const s = loadSettings();
    const i = document.getElementById("sDefaultBreak");
    if(i){
      i.value = Number(s.defaultBreak ?? 30);
      i.addEventListener("input", () => {
        const v = Number(i.value || 0);
        const ns = loadSettings();
        ns.defaultBreak = Math.max(0, v);
        saveSettings(ns);
      });
    }
  })();

  function exportData(){
    const payload = {
      version: 1,
      exportedAt: new Date().toISOString(),
      passMap: loadPassMap(),
      statusMap: loadStatus(),
      settings: loadSettings(),
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    const key = ymd(new Date());
    a.href = URL.createObjectURL(blob);
    a.download = `schema-backup-${key}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(a.href), 2000);
  }

  function importData(event){
    const file = event?.target?.files?.[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const obj = JSON.parse(String(reader.result || "{}"));
        const passMap = obj.passMap && typeof obj.passMap === "object" ? obj.passMap : null;
        const statusMap = obj.statusMap && typeof obj.statusMap === "object" ? obj.statusMap : null;
        const settings = obj.settings && typeof obj.settings === "object" ? obj.settings : {defaultBreak:30};
        if(!passMap || !statusMap) throw new Error("Ogiltigt backup-format");
        if(!confirm("Importera backup? Detta skriver √∂ver nuvarande data.")) return;
        savePassMap(passMap);
        saveStatus(statusMap);
        saveSettings(settings);
        // sync settings input
        const i = document.getElementById("sDefaultBreak");
        if(i) i.value = Number(settings.defaultBreak ?? 30);
        render();
        alert("Import klar!");
      }catch(e){
        alert("Kunde inte importera filen (fel format).");
      }finally{
        event.target.value = "";
      }
    };
    reader.readAsText(file);
  }

  function resetAll(){
    if(!confirm("Nollst√§lla ALLT? Detta tar bort alla pass och markeringar.")) return;
    localStorage.removeItem("passMap");
    localStorage.removeItem("statusMap");
    localStorage.removeItem("settings");
    const i = document.getElementById("sDefaultBreak");
    if(i) i.value = 30;
    render();
  }

  function goToday(){
    const t = new Date();
    currentYear = t.getFullYear();
    currentMonth = t.getMonth();
    render();
  }

  render();
</script>
</body>
</html>
